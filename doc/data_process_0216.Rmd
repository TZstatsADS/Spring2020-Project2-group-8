---
title: "data_process"
author: "Hanbo JIAO, Haoyu SHANG"
date: "2020/2/15"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)

menu_raw <-read_csv("C:/Users/jiaoh/OneDrive/桌面/MenuStat.csv")
location_raw <- read_csv("C:/Users/jiaoh/OneDrive/桌面/NY Restaurant Location.csv")


menu<-menu_raw[,-c(19,24:45)]# no nutrition_text and nutrition_100g col, potassium col (since only 5k entry have value)
menu_info<-menu%>%group_by(restaurant)%>%nest()%>%rename("menu"=data)
menu_name<-menu%>%group_by(restaurant)%>%summarise(n=n())%>%arrange(desc(n))



x<-location_raw%>%group_by(CAMIS)%>%arrange(desc(`INSPECTION DATE`))%>%select(CAMIS,BORO:ZIPCODE,`INSPECTION DATE`,Latitude,Longitude)%>%unique%>%top_n(1,`INSPECTION DATE`)
location<-location_raw%>%select(CAMIS,DBA)%>%unique

res_location<- left_join(x,location) 

location_name<-res_location%>%group_by(DBA)%>%nest()


name_menu<-menu_name$restaurant%>%str_replace_all("'s", "")%>%str_replace_all("Shop", "")%>%str_replace_all("`S", "")
name_loc<-location_name$DBA%>%str_replace_all("'s", "")%>%str_replace_all("Shop", "")%>%str_replace_all("`S", "")

xx<-name_menu%>%map(~grep(.x,name_loc, ignore.case = T)) #index
yy<-name_menu%>%map(~grep(.x,name_loc, ignore.case = T,value = T)) #matched name

index<-xx%>%map(~(length(.x)>0))%>%unlist #successful matched index in menu
coord<-xx[index]                          #successful matched cor in location

# yy[index] ## check

# name_menu[index]  #matched store
# name_menu[!index] #unmatched store


joinname<-NULL
for (i in seq_along(coord)){
  joinname<-rbind(joinname,tibble(locationid=coord[[i]],menuid=i))
}

menu_join<-menu_name[index,]%>%mutate(id=row_number())

location_join<-location_name%>%ungroup%>%mutate(id=row_number())%>%right_join(joinname,by=c("id"="locationid"))%>%unnest%>%group_by(menuid)%>%nest

loc_info<-inner_join(menu_join,location_join,by=c("id"="menuid"))%>%unnest%>%select(restaurant,BORO,BUILDING,STREET,ZIPCODE,Latitude,Longitude)%>%group_by(restaurant)%>%nest()%>%rename("location"=data)


menu_nutrition_location<-left_join(loc_info,menu_info,by="restaurant")
save(menu_nutrition_location, file="../output/menu_nutrition_location.RDatautrition_location.RData")

```









